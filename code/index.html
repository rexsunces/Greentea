<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <link href="css/swiper.css" rel="stylesheet" />
    <link href="css/bootstrap.css" rel="stylesheet" />
    <link href="css/style.css?v=2" rel="stylesheet" />
    <script src="js/zepto.min.js"></script>
    <script src="js/touch.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/jquery.easie.js"></script>
    <link href="css/haoest.min.css" rel="stylesheet" />
    <style>
        @-webkit-keyframes myfirst {
            0% {
                width: 10%;
                top: 40%;
                left: 40%;
            }





            100% {
                width: 30%;
                left: 10%;
                top: 50%;
            }
        }

        @keyframes myfirst {
            0% {
                width: 10%;
                top: 40%;
                left: 40%;
            }





            100% {
                width: 30%;
                left: 10%;
                top: 50%;
            }
        }
        @-webkit-keyframes mtime {
            0% {
                opacity: 1;
                top: 20%;
            }





            100% {

                top: 15%;
                opacity:0;
            }
        }

        @keyframes mtime {
            0% {
                opacity: 1;
                top: 20%;
            }





            100% {
                top: 15%;
                opacity: 0;
            }
        }
        .myani {
            animation: myfirst 2s;
            -moz-animation: myfirst 2s; /* Firefox */
            -webkit-animation: myfirst 2s; /* Safari 和 Chrome */
            -o-animation: myfirst 2s; /* Opera */
            animation-timing-function: linear;
        }

        body {
            padding: 0px;
            margin: 0px;
            font-family:'Microsoft YaHei';
        }

        .hide {
            display: none;
        }

        .page {
            width: 100%;
            height: 100%;
            position: absolute;
            background-size: 100% 100%;
        }


        .page-0 {
            background-color: #dc292d;
        }

            .page-0 .loading {
                width: 30%;
                height: 40%;
                position: absolute;
                left: 50%;
                top: 40%;
                margin-top: -20%;
                margin-left: -15%;
                font-size: 20%;
                color: #000;
            }

            .page-0 .loading-img {
                width: 100%;
                margin-bottom: 10%;
            }

            .page-0 .loading div {
                position: absolute;
                width: 100%;
                top: 50%;
                text-align: center;
                font-size: 20px;
                font-family: fantasy;
            }

        .page.page-index {
            background-image: url('img/green-back-new.png');
        }
        .page.page-rank {
            background-image: url('img/rank.png');
        }
        .page-rank .rank-return-btn {
            top: 88%;
            left: 5%;
            width: 30%;
            position: absolute;
        }

        .page-rank .rank-opacity-div {
            position: absolute;
            top: 28%;
            left: 5%;
            width: 90%;
            height: 50%;
            background-color: white;
            opacity: 0.7;
            border-radius: 20px;
        }

        .page-rank .rank-table-div {
            position: absolute;
            top: 28%;
            left: 5%;
            width: 90%;
            min-height: 50%;
        }

        .page-rank table {
            margin-left: auto;
            margin-right: auto;
            margin-top: 20px;
            width: 95%;
            text-align: center;
            font-size: 8px;
        }

            .page-rank table th {
                height: 20px;
                border-radius: 5px;
                border: 2px solid white;
            }

            .page-rank table .th-xuhao {
                width: 12%;
                border-radius: 5px;
                border: 2px solid white;
            }

            .page-rank table .th-normal {
                width: 22%;
                border-radius: 5px;
                border: 2px solid white;
            }

            .page-rank table td {
                height: 20px;
                border-radius: 5px;
                border: 2px solid white;
            }
        .page.page-gaozhi{
            background-image:url('img/gaozhi.png');
        }
        .page-gaozhi .gaozhi-rank-btn {
            position: absolute;
            top: 82%;
            left: 15%;
            width: 50%;
        }
            .page-gaozhi .gaozhi-enter-btn {
                position: absolute;
                width: 70%;
                height: 10%;
                top: 70%;
                left: 15%;
                z-index: 1000;
            }
        .kl {
            position: absolute;
            width: 10%;
            top: 40%;
            left: 40%;
        }

        .roadline {
            position: absolute;
            width: 5%;
            height: 50%;
            left: 48%;
            top: 38%;
        }
        .roadline-long {
            position: absolute;
            width: 5%;
            height: 60%;
            left: 48%;
            top: 38%;
        }

        .jiasu {
            position: absolute;
            width: 18%;
            left: 75%;
            top: 86%;
            z-index: 999;
        }

        .banana-left-start {
            position: absolute;
            top: 40%;
            left: 35%;
            width: 10%;
            /*top: 60%;
            left: 10%;
            width: 20%;*/
        }

        .banana-right-start {
            position: absolute;
            left: 55%;
            width: 10%;
            top: 40%;
            /*left: 65%;
            width: 20%;
            top: 60%;*/
        }

        .tea-left-start {
            position: absolute;
            height: 5%;
            top: 40%;
            left: 40%;
            /*height: 10%;
            top: 50%;
            left: 25%;*/
        }

        .tea-right-start {
            position: absolute;
            height: 5%;
            top: 40%;
            left: 55%;
            /*height: 10%;
            top: 55%;
            left: 65%;*/
        }
        .kualan-left-start {
            position: absolute;
            left: 40%;
            width: 10%;
            top: 40%;
        }
        .kualan-left-end {
            position: absolute;
            left: 5%;
            width: 40%;
            top: 45%;
        }
        .kualan-right-start {
            position: absolute;
            left: 52%;
            width: 10%;
            top: 40%;
        }
        .kualan-right-end {
            position: absolute;
            left: 55%;
            width: 40%;
            top: 45%;
        }
        .final-start {
            width: 8%;
            left: 47%;
            position: absolute;
            top: 38%;
        }
        .final-end {
            width: 80%;
            left: 12%;
            position: absolute;
            top: 30%;
        }

        .bike-left {
            position: absolute;
            height: 40%;
            top: 45%;
            z-index: 998;
        }

        .bike-right {
            position: absolute;
            /* width: 40%; */
            height: 40%;
            top: 45%;
            left: 60%;
            z-index: 998;
        }

        .left {
            width: 16%;
            height: 10%;
            position: absolute;
            left: 29%;
            top: 85%;
        }

        .right {
            width: 16%;
            height: 10%;
            position: absolute;
            left: 55%;
            top: 85%;
        }

        .tree {
            position: absolute;
            width: 30%;
            bottom: 0px;
            left: 70%;
        }

        .using-time-span {
            position: absolute;
            width: 32%;
            left: 10%;
            top: 20%;
            font-size: 20px;
            color: crimson;
            font-weight: bolder;
            z-index: 997;
            /*font-style: italic;
            font-family: fantasy;*/
        }
        .miles {
            position: absolute;
            width: 30%;
            top: 20%;
            left: 70%;
            font-size: 20px;
            color: crimson;
            font-weight: bolder;
            z-index:997;
        }
        .textmask {
            position: absolute;
            width: 80%;
            height:25px;
            left: 10%;
            top: 20%;
            border-radius:10px;
            background-color:lightblue;
            opacity:0.7;
        }
        .timeplus-ani {
            animation: mtime 1s;
            -moz-animation: mtime 1s; /* Firefox */
            -webkit-animation: mtime 1s; /* Safari 和 Chrome */
            -o-animation: mtime 10s; /* Opera */
            animation-timing-function: linear;


        }
        .timeplus {
            opacity: 1;
            position: absolute;
            width: 15%;
            left: 40%;
            top: 20%;
            font-size: 20px;
            color: red;
            font-weight: bolder;
            z-index: 997;
        }
        .timeminus {
            opacity: 1;
            position: absolute;
            width: 15%;
            left: 40%;
            top: 20%;
            font-size: 20px;
            color: green;
            font-weight: bolder;
            z-index: 997;
        }
        .video {
            position: relative;
            background-image: url('img/video.png');
            background-size: 100% 100%;
            width: 40%;
            height: 20%;
        }
        .video-right {
            left: 60%;
        }
        .video-left{
            left:5%;
        }
        .video-point-now {
            height: 5%;
            width: 5%;
            left: 30%;
            background-color: floralwhite;
            border-radius: 10px;
            position: absolute;
            bottom: 2%;
        }
        .video-point-first {
            height: 5%;
            width: 5%;
            left: 65%;
            background-color: red;
            border-radius: 10px;
            position: absolute;
            bottom: 2%;
        }
        .rules {
            position: absolute;
            width: 80%;
            left: 10%;
            top: 15%;
            z-index: 998;
        }

        .close-rule-btn {
            position: absolute;
            width: 10%;
            left: 78%;
            top: 16%;
            z-index: 999;
        }
        .rule-btn {
            position: absolute;
            left: 25%;
            width: 28%;
            top: 3%;
        }
        th {
            background-color: white;
        }

        td {
            background-color: white;
        }
    </style>

</head>
<body onload="PageCtl.loadComplete()">
    <div class="page page-0 page-current">
        <div class="loading">
            <img class="loading-img ani-rotateRight ani-iteration-infinite" src="img/loading.png" />
            <div>Loading</div>
        </div>
    </div>
    <div class="page page-gaozhi hide" >
        <div class="gaozhi-enter-btn"></div>
        <img class="gaozhi-rank-btn" src="img/gaozhi-rank-btn.png" />
    </div>
    <div class="page page-index hide">
        <img class="roadline" src="img/roadline_new4.png" />
        <img class="roadline-long hide" src="img/road-small.png" />
        <img class="jiasu" src="img/jiasu.png" />
        <img class="mbanana hide" src="img/banana.png" />
        <span class="miles">1000米</span>
        <img class="bike bike-left" src="img/bike.png" />
        <img class="left" src="img/left.png" />
        <img class="right" src="img/right.png" />
        <div class="textmask"></div>
        <div class="using-time-span">0.00S</div>
        <img class="tree" src="img/tree.png" />
        <div class="video video-right">
            <div class="video-point-now"></div>
            <div class="video-point-first"></div>
        </div>
        <div class="rule-div hide">
            <img class="rules" src="img/rules.png" />
            <img class="close-rule-btn" src="img/close-rule-btn.png" />
        </div>
        <img class="rule-btn" src="img/rule-btn.png" />
    </div>
    <div class="page-rank page hide">
        <div class="rank-opacity-div">
        </div>
        <div class="rank-table-div">
            <table class="rank-table"></table>
        </div>
        <img class="rank-return-btn" src="img/rank-return-btn.png" />
    </div>
</body>
<script>
    var nowUserId;
    var gameId = "greentea20150726";
    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
        var r = window.location.search.substr(1).match(reg);  //匹配目标参数
        if (r != null) return unescape(r[2]); return null; //返回参数值
    }
    //获取当前用户的微信Id
    function GetNowUserId() {
        nowUserId = getUrlParam("openid");
        if (nowUserId != null) {
            window.localStorage.setItem('haizhiyan01', nowUserId);
            window.location = 'index.html?tag=0';
            return false;
        }
        nowUserId = window.localStorage.getItem('haizhiyan01');
        if (nowUserId == null || nowUserId == '') {
            //需要授权获取用户id
            window.location = '/wx/getopenidbyoath2.php?url=' + encodeURIComponent(window.location.pathname + window.location.search);
            return false;
        }
    }
    GetNowUserId();

    var gameStart = false;
    var a = new Array();
    var mtime = 0;
    var miles = 0;//
    var maxmiles = 1000;
    var gametimer;
    var firstRoadVideo;
    var currentRoadVideo = "";
    var map = new Array();
    var videoTimer;
    var mdelay = false;
    var mminus = false;
    //var map = {
    //    banana800: {
    //        isLeft: true,
    //        left: 35,
    //        top: 40
    //    },
    //    tea920: {
    //        isLeft: true,
    //        left: 55,
    //        top: 40
    //    },
    //    banana950: {
    //        isLeft: false,
    //        left: 55,
    //        top: 40
    //    },
    //    kualan750:{
    //        isLeft: false
    //    },
    //    banana700: {
    //        isLeft: true,
    //        left: 35,
    //        top: 40
    //    },
    //    kualan620:{
    //        isLeft:true
    //    },
    //    banana500: {
    //        isLeft: false,
    //        left: 55,
    //        top: 40
    //    },
    //    tea300: {
    //        isLeft: false,
    //        left: 55,
    //        top: 40
    //    },
    //    final100:{
        
    //    }

    //}
    var ii = 0;
    var speed = 1;
    var PageCtl = {
        gamePoint: 0,

        currentPageNumber: 0,

        effects: { moveUp: 1, moveDown: 2, fade: 3 },

        directions: { up: 1, down: -1 },

        isAnimating: false,

        pageMove: function (effect, pageNumber) {
            if (!PageCtl.isAnimating) {
                PageCtl.isAnimating = true;
                var fromPage = ".page-" + PageCtl.currentPageNumber;
                var toPage = ".page-" + pageNumber;
                PageCtl.currentPageNumber = pageNumber;

                switch (effect) {
                    case PageCtl.effects.fade:
                        outClass = 'ani-fadeOut';
                        inClass = 'ani-fadeIn';
                        break;
                }

                $(toPage).removeClass("hide");
                $(fromPage).addClass(outClass);
                $(toPage).addClass(inClass);

                setTimeout(function () {
                    $(fromPage).removeClass('page-current');
                    $(fromPage).removeClass(outClass);
                    $(fromPage).addClass("hide");
                    //$(fromPage).find("*").addClass("hide");

                    $(toPage).addClass('page-current');
                    $(toPage).removeClass(inClass);
                    //$(toPage).find("*").removeClass("hide");

                    PageCtl.isAnimating = false;
                }, 600);
            }
        },


        loadComplete: function () {
            PageCtl.pageMove(PageCtl.effects.fade, "gaozhi");
        }
    };
    var $j = jQuery.noConflict();
    $(function () {
        $('.gaozhi-enter-btn').on('touchstart pointerdown', function () {
            PageCtl.pageMove(PageCtl.effects.fade, "index");
        })
        $('.gaozhi-rank-btn').on('touchstart pointerdown', function () {
            $('.rank-table').html("");
            $.get("/index.php?r=game/getrankbytime", {
                "gameId": gameId
            }, function (data, textStatus) {
                if (data.success = true) {
                    //获取成功
                    var rankstr = "<tr><th class='th-xuhao'>序号</th><th class='th-normal'>昵称</th><th class='th-normal'>骑行时间</th><th class='th-normal'>挑战次数</th><tr>";
                    for (var i = 0; i < data.data.length; i++) {
                        rankstr += "<tr>" +
                            "<td class='th-align-center'>" + parseInt(i + 1) +
                            "</td><td class='th-align-center'>" + formatPalyerName(data.data[i].user_name == null ? data.data[i].user_id : data.data[i].user_name) +
                            "</td><td class='th-align-center'>" + (data.data[i].time_used == null ? "-" : (data.data[i].time_used / 1000).toFixed(2)) + " S" +
                            "</td><td class='th-align-center'>"+(data.data[i].times)
                            "</td></tr>";
                    }
                    $('.rank-table').append(rankstr);
                    PageCtl.pageMove(PageCtl.effects.fade, "rank");
                }
                else {
                    alert("数据获取失败！");
                }
            })
        })
        $('.rank-return-btn').on('touchstart pointerdown', function () {
            PageCtl.pageMove(PageCtl.effects.fade, "gaozhi");
        })
        $('.rule-btn').on('singleTap', function () {
            if ($('.rule-div').hasClass("hide")) {
                $('.rule-div').removeClass("hide");
            }
        })
        $('.close-rule-btn').on('singleTap', function () {
            $('.rule-div').addClass("hide");
        })


        $('.left').on('touchstart pointerdown', function () {
            $('.bike').removeClass("bike-right").addClass("bike-left");
        })
        $('.right').on('touchstart pointerdown', function () {
            $('.bike').removeClass("bike-left").addClass("bike-right");
        })
      
        function leftTeaAni(_maxmiles) {
            if (a[_maxmiles] == 10) {
                if ($('.bike').hasClass("bike-left")) {
                    $('.page-index').append("<div id='timeminus" + _maxmiles + "' class='timeminus'> -1 S</div>");
                    $j('#timeminus' + _maxmiles).animate({ opacity: 0, top: '13%' }, 500)
                    mtime -= 1000;
                    //maxmiles =maxmiles - parseInt(parseFloat(1000 / (1000 - 100 * speed)) * 10);
                    mminus = true;
                  
                }
                $('#tea-' + _maxmiles).addClass("hide").removeClass("tea-left-start");
                return false;
            }
            else {
                setTimeout(function () {
                    a[_maxmiles]++;
                    $('#tea-' + _maxmiles).css("top", (40 + a[_maxmiles] * 1.5) + "%");
                    $('#tea-' + _maxmiles).css("height", (5 + a[_maxmiles] * 0.5) + "%");
                    $('#tea-' + _maxmiles).css("left", (40 - a[_maxmiles] * 1.5) + "%");
                    leftTeaAni(_maxmiles);

                }, 800 - 100 * speed);
            }
        }
        function rightTeaAni(_maxmiles) {
            if (a[_maxmiles] == 10) {
                if ($('.bike').hasClass("bike-right")) {
                    $('.page-index').append("<div id='timeminus" + _maxmiles + "' class='timeminus'> -1 S</div>");
                    $j('#timeminus' + _maxmiles).animate({ opacity: 0, top: '13%' }, 500)
                    mtime -= 1000;
                    // maxmiles = maxmiles - parseInt(parseFloat(1000 / (1000 - 100 * speed)) * 10);
                    mminus = true;
                   
                }
                $('#tea-' + _maxmiles).addClass("hide").removeClass("tea-right-start");
                return false;
            }
            else {
                setTimeout(function () {
                    a[_maxmiles]++;
                    $('#tea-' + _maxmiles).css("top", (40 + a[_maxmiles] * 1.5) + "%");
                    $('#tea-' + _maxmiles).css("height", (5 + a[_maxmiles] * 0.5) + "%");
                    $('#tea-' + _maxmiles).css("left", (55 + a[_maxmiles] * 1) + "%");
                    rightTeaAni(_maxmiles);

                }, 800 - 100 * speed);
            }
        }



        function leftKualanAni(_maxmiles) {
            if (a[_maxmiles] == 10) {
                if ($('.bike').hasClass("bike-left")) {
                    $('.page-index').append("<div id='timeplus" + _maxmiles + "' class='timeplus'> +1 S</div>");
                    $j('#timeplus' + _maxmiles).animate({ opacity: 0, top: '13%' }, 500)
                    mtime += 1000;
                    // maxmiles = maxmiles + parseInt(parseFloat(1000 / (1000 - 100 * speed)) * 10);
                    mdelay = true;

                }
                $('#kualan-' + _maxmiles).addClass("hide").removeClass("kualan-left-start");
                return false;
            }
            else {
                setTimeout(function () {
                    a[_maxmiles]++;
                    $('#kualan-' + _maxmiles).css("top", (40 + a[_maxmiles] * 0.5) + "%");
                    $('#kualan-' + _maxmiles).css("width", (10 + a[_maxmiles] * 3) + "%");
                    $('#kualan-' + _maxmiles).css("left", (40 - a[_maxmiles] * 3.5) + "%");
                    leftKualanAni(_maxmiles);

                }, 800 - 100 * speed);
            }
        }
        function rightKualanAni(_maxmiles) {
            if (a[_maxmiles] == 10) {
                if ($('.bike').hasClass("bike-right")) {
                    $('.page-index').append("<div id='timeplus" + _maxmiles + "' class='timeplus'> +1 S</div>");
                    $j('#timeplus' + _maxmiles).animate({ opacity: 0, top: '13%' }, 500)
                    mtime += 1000;
                    // maxmiles = maxmiles + parseInt(parseFloat(1000 / (1000 - 100 * speed)) * 10);
                    mdelay = true;

                }
                $('#kualan-' + _maxmiles).addClass("hide").removeClass("kualan-right-start");
                return false;
            }
            else {
                setTimeout(function () {
                    a[_maxmiles]++;
                    $('#kualan-' + _maxmiles).css("left", (52 + a[_maxmiles] * 0.3) + "%");
                    $('#kualan-' + _maxmiles).css("width", (10 + a[_maxmiles] * 3) + "%");
                    $('#kualan-' + _maxmiles).css("top", (40 + a[_maxmiles] * 0.5) + "%");
                    rightKualanAni(_maxmiles);

                }, 800 - 100 * speed);
            }
        }
        function kualan(_maxmiles, lor) {
            if (a[_maxmiles] == undefined) {
                a[_maxmiles] = 0;
            }
            if (a[_maxmiles] == 10) {
                return false;
            }
            switch (lor) {
                case 0://left
                    var kuastr = " <img id='kualan-" + _maxmiles + "' class='hide' src='img/kualan3.png' />";
                    $('.page-index').append(kuastr);
                    $('#kualan-' + _maxmiles).addClass("kualan-left-start").removeClass("hide");
                    leftKualanAni(_maxmiles);
                    break;
                case 1:
                    var kuastr = " <img id='kualan-" + _maxmiles + "' class='hide' src='img/kualan3.png' />";
                    $('.page-index').append(kuastr);
                    $('#kualan-' + _maxmiles).addClass("kualan-right-start").removeClass("hide");
                    rightKualanAni(_maxmiles);

                    break;
                default: break;
            }
        }


        function tea(_maxmiles, lor) {
            if (a[_maxmiles] == undefined) {
                a[_maxmiles] = 0;
            }
            if (a[_maxmiles] == 10) {
                return false;
            }
            switch (lor) {
                case 0://left
                    var teastr = " <img id='tea-" + _maxmiles + "' class='hide' src='img/tea.png' />";
                    $('.page-index').append(teastr);
                    $('#tea-' + _maxmiles).addClass("tea-left-start").removeClass("hide");
                    leftTeaAni(_maxmiles);
                    break;
                case 1:
                    var teastr = " <img id='tea-" + _maxmiles + "' class='hide' src='img/tea.png' />";
                    $('.page-index').append(teastr);
                    $('#tea-' + _maxmiles).addClass("tea-right-start").removeClass("hide");
                    rightTeaAni(_maxmiles);

                    break;
                default: break;
            }
        }

        function leftBananaAni(_maxmiles) {
            if (a[_maxmiles] == 10) {
                if ($('.bike').hasClass("bike-left")) {
                    $('.page-index').append("<div id='timeplus" + _maxmiles + "' class='timeplus'> +1 S</div>");
                    $j('#timeplus' + _maxmiles).animate({ opacity: 0, top: '13%' }, 500)
                    mtime += 1000;
                    //maxmiles = maxmiles + parseInt(parseFloat(1000 / (1000 - 100 * speed)) * 10);
                    mdelay = true;
                }
                $('#banana-' + _maxmiles).addClass("hide").removeClass("banana-left-start");
                return false;
            }
            else {
                setTimeout(function () {
                    a[_maxmiles]++;

                    $('#banana-' + _maxmiles).css("top", (40 + a[_maxmiles] * 2) + "%");
                    $('#banana-' + _maxmiles).css("width", (10 + a[_maxmiles] * 1) + "%");
                    $('#banana-' + _maxmiles).css("left", (35 - a[_maxmiles] * 2.5) + "%");
                    leftBananaAni(_maxmiles);

                }, 800 - 100 * speed);
            }
        }
        function rightBananaAni(_maxmiles) {
            if (a[_maxmiles] == 10) {
                if ($('.bike').hasClass("bike-right")) {
                    $('.page-index').append("<div id='timeplus" + _maxmiles + "' class='timeplus'> +1 S</div>");
                    $j('#timeplus' + _maxmiles).animate({ opacity: 0, top: '13%' }, 500)
                    mtime += 1000;
                    // maxmiles = maxmiles +parseInt(parseFloat(1000 / (1000 - 100 * speed)) * 10);
                    mdelay = true;
                }
                $('#banana-' + _maxmiles).addClass("hide").removeClass("banana-right-start");
                return false;
            }
            else {
                setTimeout(function () {
                    a[_maxmiles]++;
                    $('#banana-' + _maxmiles).css("top", (40 + a[_maxmiles] * 2) + "%");
                    $('#banana-' + _maxmiles).css("width", (10 + a[_maxmiles] * 1) + "%");
                    $('#banana-' + _maxmiles).css("left", (55 + a[_maxmiles] * 1) + "%");
                    rightBananaAni(_maxmiles);

                }, 800 - 100 * speed);
            }
        }
        function banana(_maxmiles, lor) {
            if (a[_maxmiles] == undefined) {
                a[_maxmiles] = 0;
            }
            if (a[_maxmiles] == 10) {
                return false;
            }
            switch (lor) {
                case 0://left
                    var bananastr = " <img id='banana-" + _maxmiles + "' class='hide' src='img/banana.png' />";
                    $('.page-index').append(bananastr);
                    $('#banana-' + _maxmiles).addClass("banana-left-start").removeClass("hide");
                    leftBananaAni(_maxmiles);
                    break;
                case 1:
                    var bananastr = " <img id='banana-" + _maxmiles + "' class='hide' src='img/banana.png' />";
                    $('.page-index').append(bananastr);
                    $('#banana-' + _maxmiles).addClass("banana-right-start").removeClass("hide");
                    rightBananaAni(_maxmiles);

                    break;
                default: break;
            }
        }
        function finalCreate(_maxmiles) {
            var finalstr = " <img id='final-" + _maxmiles + "' class='hide' src='img/final.png' />";
            $('.page-index').append(finalstr);
            $('#final-' + _maxmiles).addClass("final-start").removeClass("hide");
            finalGo(_maxmiles);
        }
        function finalGo(_maxmiles) {
            if (a[_maxmiles] == undefined) {
                a[_maxmiles] = 0;
            }
            if (a[_maxmiles] == 10) {
                return false;
            }
            else {
                setTimeout(function () {
                    a[_maxmiles]++;
                    $('#final-' + _maxmiles).css("top", (38 - a[_maxmiles] * 0.8) + "%");
                    $('#final-' + _maxmiles).css("width", (8 + a[_maxmiles] * 7.2) + "%");
                    $('#final-' + _maxmiles).css("left", (47 - a[_maxmiles] * 3.5) + "%");
                    finalGo(_maxmiles);

                }, 800 - 100 * speed);
            }
        }


        

        //setInterval(function () {
        //    ii++;
        //    if (ii % 2 == 0) {
        //        $('.roadline').css("top", "45%");
        //    }
        //    else {
        //        $('.roadline').css("top", "35%");
        //    }

        //}, 500-10*speed);
        // GameTimerStart();
        $('.jiasu').on('touchstart pointerdown', function () {
            if (gameStart == false) {
                gameStart = true;

                InitMap();
                GetFirst();
                
            }
            else{
                speed++;
                if (speed == 4) {
                    $(this).unbind();
                }
            }
        })


        function GameTimerGo() {
            go(800);
            gametimer = setInterval(function () {
                mtime += 10;
                $('.using-time-span').text((mtime / 1000).toFixed(2) + "S");
                if (mdelay == true) {
                    mdelay = false;
                    currentRoadVideo += ((maxmiles) + "" + ",");
                }
                if (mminus == true) {
                    mminus = false;
                    try{
                        currentRoadVideo=(currentRoadVideo.substring(0, currentRoadVideo.length - 1)).substring(0, (currentRoadVideo.substring(0, currentRoadVideo.length - 1)).lastIndexOf(",") + 1)
                    }
                    catch (err) {

                    }
                }
                if (mtime % 1000 == 0) {
                    currentRoadVideo += ((maxmiles) + "" + ",");
                }
            }, 10);
        }
        function go(_speed) {
            setTimeout(function () {
                miles++;
                $('.miles').text(maxmiles + "米");
                if (maxmiles <= 0) {//游戏结束
                    SubmitScore();
                    clearInterval(gametimer);
                    return false;
                }
                if (map.hasOwnProperty("banana" + maxmiles)) {
                    if (a[maxmiles] == undefined) {
                        if (map["banana" + maxmiles].isLeft == true) {
                            banana(maxmiles, 0);
                        }
                        else {
                            banana(maxmiles, 1);
                        }
                    }
                }
                if (map.hasOwnProperty("tea" + maxmiles)) {
                    if (a[maxmiles] == undefined) {
                        if (map["tea" + maxmiles].isLeft == true) {
                            tea(maxmiles, 0);
                        }
                        else {
                            tea(maxmiles, 1);
                        }
                    }
                }
                if (map.hasOwnProperty("kualan" + maxmiles)) {
                    if (a[maxmiles] == undefined) {
                        if (map["kualan" + maxmiles].isLeft == true) {
                            kualan(maxmiles, 0);
                        }
                        else {
                            kualan(maxmiles, 1);
                        }
                    }
                }
                if (map.hasOwnProperty("final" + maxmiles)) {
                    finalCreate(maxmiles);
                }
                ii++;
                if (ii % 2 == 0) {
                    $('.roadline-long').addClass("hide");
                    $('.roadline').removeClass("hide");

                }
                else {
                    $('.roadline').addClass("hide");
                    $('.roadline-long').removeClass("hide");
                }
                if (maxmiles<110&& maxmiles>100) {
                    maxmiles = 110;
                }
                if (maxmiles < 10 && maxmiles > 0) {
                    maxmiles = 10;
                }
                maxmiles -= 10;

                go(800 - 100 * speed);
            }, _speed);
        }
        function GameEnd() {
            speed = 1;
            gameStart = false;
            currentRoadVideo = "";
            firstRoadVideo = "";
            map = {};
            maxmiles = 1000;
            ii = 0;
            mtime = 0;
            clearInterval(videoTimer);
            $('.using-time-span').text((mtime / 1000).toFixed(2) + "S");
            $('.miles').text(maxmiles + "米");
            $('.final-start').remove();
            $('.banana-left-start').remove();
            $('.tea-left-start').remove();
            $('.kualan-left-start').remove();
            $('.banana-right-start').remove();
            $('.tea-right-start').remove();
            $('.kualan-right-start').remove();
            $('.video-point-now').css("top", parseFloat(maxmiles / 1100).toFixed(2) * 100 + "%");
            $('.video-point-first').css("top", parseFloat(maxmiles / 1100).toFixed(2) * 100 + "%");
            $('.timeplus').remove();
            $('.timeminus').remove();
            a = {};

            $('.jiasu').on('touchstart pointerdown', function () {
                if (gameStart == false) {
                    gameStart = true;

                    InitMap();
                    GetFirst();

                }
                else {
                    speed++;
                    if (speed == 4) {
                        $(this).unbind();
                    }
                }
            })
        }

        function InitMap() {
            for (var i = 200; i < 1000; i += 100) {
                var rand = Math.random();
                if (rand < 0.2) {
                    var rand2 = Math.random();
                    if (rand2 < 0.5) {
                        map["tea" + i] = {
                            isLeft: false
                        }
                    }
                    else {
                        map["tea" + i] = {
                            isLeft: true
                        }
                    }

                }
                else if (rand < 0.5) {
                    var rand2 = Math.random();
                    if (rand2 < 0.5) {
                        map["banana" + i] = {
                            isLeft: false
                        }
                    }
                    else {
                        map["banana" + i] = {
                            isLeft: true
                        }
                    }
                }
                else if (rand < 0.8) {
                    var rand2 = Math.random();
                    if (rand2 < 0.5) {
                        map["kualan" + i] = {
                            isLeft: false
                        }
                    }
                    else {
                        map["kualan" + i] = {
                            isLeft: true
                        }
                    }
                }
                else {

                }
            }
            map["final100"] = {};
        }

        function GetFirst() {
            $.post("/index.php?r=game/gettoprecord", {
                "gameId": gameId,
            }, function (data, textStatus) {
                if (data.success = true) {
                    //获取成功
                    if (data.data == null) {
                        firstRoadVideo = "";
                    }
                    else {
                        firstRoadVideo = data.data.content;
                    }
                    var j = 0;
                    var x1 = firstRoadVideo.split(",");
                    videoTimer= setInterval(function () {
                        $('.video-point-now').css("top", parseFloat(maxmiles / 1100).toFixed(2) * 100 + "%");
                        if (j < x1.length) {
                            $('.video-point-first').css("top", parseFloat(x1[j] / 1100).toFixed(2) * 100 + "%");
                        }
                        else {
                            $('.video-point-first').css("top", 0 + "%");
                        }
                        j++;

                    }, 1000);
                    GameTimerGo();
                }
                else {
                    alert("访问后台失败！");
                    firstRoadVideo = "";
                    //GameReset();

                }
            })
        }
        function SubmitScore() {
            $.post("/index.php?r=game/play", {
                "userId": nowUserId,
                "gameId": gameId,
                "timeUsed": mtime,
                "record": currentRoadVideo.substring(0, currentRoadVideo.length - 1)
            }, function (data, textStatus) {
                if (data.success = true) {
                    //更新成功
                    alert("恭喜完成疯狂急速骑行，快快邀请好友一起挑战吧！");
                    GameEnd();
                   // PageCtl.pageMove(PageCtl.effects.fade, "gaozhi");
                    window.location.href = "index.html";
                    //GameReset();
                }
                else {
                    alert("上传成绩失败！");
                    //GameReset();

                }
            })
        }

    })


    function formatPalyerName(strName) {
        var lengthx2 = 4;
        var j = 0;
        var str = "";
        if (strlen(strName) > 6) {
            // return strName.substr(0, 4) + '...';
            for (var i = 0; i < strName.length; i++) {

                if (j <= lengthx2) {
                    var c = strName.charCodeAt(i);
                    if ((c >= 0x0001 && c <= 0x007e) || (0xff60 <= c && c <= 0xff9f)) {
                        j++;
                        str = str + strName[i];
                    }
                    else {
                        j = j + 2;
                        str = str + strName[i];
                    }
                }
                else {
                    str = str + "...";
                    break;
                }
            }
            return str;
        }
        else {
            return strName;
        }

    }
    function strlen(str) {
        var len = 0;
        for (var i = 0; i < str.length; i++) {
            var c = str.charCodeAt(i);
            //单字节加1 
            if ((c >= 0x0001 && c <= 0x007e) || (0xff60 <= c && c <= 0xff9f)) {
                len++;
            }
            else {
                len += 2;
            }
        }
        return len;
    }
</script>

</html>
